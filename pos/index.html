<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta Virtual</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #e3f2fd;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #333;
            overflow: hidden;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 100%;
            transition: transform 0.5s ease-in-out;
        }
        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #007bff;
            position: relative;
        }
        h1::after {
            content: "";
            font-size: 1.5rem;
            position: absolute;
            right: -40px;
            top: 0;
            animation: rotateEmoji 2s infinite linear;
        }
        @keyframes rotateEmoji {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        input[type="password"], input[type="text"] {
            width: 100%;
            padding: 14px;
            margin-bottom: 20px;
            border: 2px solid #ccc;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input[type="password"]:focus, input[type="text"]:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            transition: background-color 0.3s, transform 0.3s;
        }
        button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
        #logo {
            margin-top: 20px;
            max-width: 100px;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        #history {
            background-color: #f1f1f1;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        #history h2 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        .transaction {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .transaction .amount {
            color: #28a745;
            font-weight: bold;
        }
        .transaction .status {
            font-style: italic;
            color: #555;
        }
        #logout {
            margin-top: 10px;
            display: block;
            text-align: center;
            font-size: 14px;
            color: #dc3545;
            cursor: pointer;
            text-decoration: underline;
        }
        #remember-container {
            display: flex;
            align-items: center;
            justify-content: start;
            margin-bottom: 20px;
        }
        #remember-container input[type="checkbox"] {
            margin-right: 10px;
        }
        #export-pdf {
            background-color: #28a745;
            margin-top: 10px;
        }
        #export-pdf:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="container" id="login-container">
        <img id="logo" src="/pos/logo.png" alt="Logo">
        <h1>Iniciar Sesi贸n</h1>
        <form id="login-form">
            <input type="text" id="username" placeholder="Usuario" required>
            <input type="password" id="password" placeholder="Contrase帽a" required>
            <div id="remember-container">
                <input type="checkbox" id="remember-me">
                <label for="remember-me">Recordar Usuario</label>
            </div>
            <button type="submit">Ingresar</button>
        </form>
    </div>

    <div class="container" id="pos-container" style="display:none;">
        <h1 id="nombre-comercio"></h1>
        <img id="logo" src="/pos/logo.png" alt="Logo del Comercio">
        <form id="payment-form">
            <input type="text" id="amount" placeholder="Ingresa el monto (e.g., 10,50)" required>
            <button type="submit">Pagar</button>
        </form>
        <div id="history">
            <h2>Historial de Transacciones</h2>
            <div id="transaction-list"></div>
            <button id="export-pdf">Exportar a PDF</button>
        </div>
        <div id="bpay-container"></div>
        <span id="logout">Volver a Iniciar Sesi贸n</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.6.0/jspdf.umd.min.js"></script>
    <script src="https://pos.cromstudio.com.ve/sdk.js"></script>
    <script>
        async function cargarDatos() {
            try {
                const response = await fetch('/pos/comercio.json');
                const datosComercio = await response.json();
                return datosComercio;
            } catch (error) {
                console.error("Error al cargar los datos del comercio:", error);
                alert("Error al cargar los datos del comercio.");
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            const rememberedUsername = localStorage.getItem("rememberedUsername");
            if (rememberedUsername) {
                document.getElementById("username").value = rememberedUsername;
                document.getElementById("remember-me").checked = true;
            }
        });

        document.getElementById("login-form").addEventListener("submit", async function(event) {
            event.preventDefault();

            const datosComercio = await cargarDatos();
            const usuarioIngresado = document.getElementById("username").value;
            const contrasenaIngresada = document.getElementById("password").value;
            const rememberMeChecked = document.getElementById("remember-me").checked;

            if (usuarioIngresado === datosComercio.usuario && contrasenaIngresada === datosComercio.contrasena) {
                if (rememberMeChecked) {
                    localStorage.setItem("rememberedUsername", usuarioIngresado);
                } else {
                    localStorage.removeItem("rememberedUsername");
                }
                document.getElementById("login-container").style.transform = "translateX(-100%)";
                setTimeout(() => {
                    document.getElementById("login-container").style.display = "none";
                    document.getElementById("pos-container").style.display = "block";
                    document.getElementById("pos-container").style.transform = "translateX(0)";
                }, 500);
                document.getElementById("nombre-comercio").textContent = datosComercio.comercio;
                document.getElementById("logo").src = datosComercio.logo;
            } else {
                alert("Usuario o contrase帽a incorrectos.");
            }
        });

        document.getElementById("payment-form").addEventListener("submit", function(event) {
            event.preventDefault();

            let amount = document.getElementById("amount").value;
            amount = amount.replace(",", ".");

            if (isNaN(amount) || parseFloat(amount) <= 0) {
                alert("Por favor, ingresa un monto v谩lido.");
                return;
            }

            const bpayKey = "MWQ3OTUwYjAtNWRhYy00MWIyLWIyZGEtNjc1MjVmNTQ2NGFj";
            const reference = `REF${Date.now()}`;

            if (amount) {
                const config = {
                    clientId: bpayKey,
                    amount: parseFloat(amount),
                    ref: reference,
                    onConnected: (res) => {
                        console.log("Conexi贸n establecida:", res);
                    },
                    onSuccess: async (res) => {
                        alert("Pago exitoso. Detalles: " + JSON.stringify(res));

                        const instrId = res.data.InstrId;
                        const nbDbtr = res.data.NbDbtr;
                        const e2e = res.data.E2E;

                        const descripcion = `InstrId: ${instrId}, NbDbtr: ${nbDbtr}, E2E: ${e2e}`;
                        
                        const payload = {
                            amount: parseFloat(amount),
                            description: descripcion,
                            currency: "unit",
                            subject: "USUARIO",
                            type: "debit.toUser"
                        };

                        try {
                            const apiResponse = await fetch('https://apisms.cromstudio.com.ve:2053/api/payments', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(payload)
                            });

                            const responseData = await apiResponse.json();
                            console.log("Respuesta de la API:", responseData);
                            agregarTransaccionAlHistorial(amount, 'xito');
                        } catch (error) {
                            console.error("Error al enviar datos a la API:", error);
                            agregarTransaccionAlHistorial(amount, 'Error');
                        }
                    },
                    onReject: (res) => {
                        alert("Pago rechazado. Detalles: " + JSON.stringify(res));
                        agregarTransaccionAlHistorial(amount, 'Rechazado');
                    },
                    onError: (res) => {
                        alert("Error en la transacci贸n. Detalles: " + JSON.stringify(res));
                        agregarTransaccionAlHistorial(amount, 'Error');
                    },
                };

                if (typeof bpay !== "undefined") {
                    bpay(config).render("bpay-container");
                } else {
                    alert("El SDK de BPAY no se ha cargado correctamente.");
                }
            } else {
                alert("Por favor, ingresa un monto v谩lido.");
            }
        });

        document.getElementById("logout").addEventListener("click", function() {
            document.getElementById("pos-container").style.transform = "translateX(100%)";
            setTimeout(() => {
                document.getElementById("pos-container").style.display = "none";
                document.getElementById("login-container").style.display = "block";
                document.getElementById("login-container").style.transform = "translateX(0)";
            }, 500);
        });

        document.getElementById("export-pdf").addEventListener("click", function() {
            // Usa el constructor jsPDF directamente desde window
            const doc = new window.jspdf.jsPDF();
            
            doc.text("Historial de Transacciones", 10, 10);
            
            let y = 20;
            const transactions = document.querySelectorAll(".transaction");
            transactions.forEach((transaction) => {
                const amount = transaction.querySelector(".amount").textContent;
                const status = transaction.querySelector(".status").textContent;
                doc.text(`${amount} - ${status}`, 10, y);
                y += 10;
            });
            
            doc.save("historial_transacciones.pdf");
        });

        function agregarTransaccionAlHistorial(amount, status) {
            const transactionList = document.getElementById("transaction-list");
            const transactionElement = document.createElement("div");
            transactionElement.classList.add("transaction");
            transactionElement.innerHTML = `<span class="amount">$${parseFloat(amount).toFixed(2)}</span> <span class="status">${status}</span>`;
            transactionList.appendChild(transactionElement);
        }
    </script>
</body>
</html>
